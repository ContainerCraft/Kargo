# This GitHub Workflow will run on every push to the repository
# and will test the Kargo codebase on a Kind Kubernetes cluster.
name: CI - Kargo on Kind
on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths-ignore:
      - "devcontainer/**"
      - ".devcontainer/**"
      - ".pulumi/**"
      - ".talos/**"
      - ".kube/**"
      - "docs/**"
      - "**.md"
  pull_request:
    branches:
      - main
    paths-ignore:
      - "devcontainer/**"
      - ".devcontainer/**"
      - ".pulumi/**"
      - ".talos/**"
      - ".kube/**"
      - "docs/**"
      - "**.md"
  schedule:
    - cron: "0 2 * * *"

jobs:
  ci-kargo-kind:
    runs-on: ubuntu-latest

    steps:
      - id: checkout
        name: ‚ú® Checkout ‚ú®
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - id: kind-kubernetes
        name: üî® Kind Kubernetes üî®
        uses: helm/kind-action@v1.9.0
        env:
          ACTIONS_STEP_DEBUG: true
          KUBECONFIG: .kube/config
        with:
          wait: 30s
          cluster_name: kargo
          config: hack/kind.yaml
          ignore_failed_clean: true

      - id: pulumi-install
        name: üì¶Ô∏è Pulumi Install üì¶Ô∏è
        uses: pulumi/actions@v5

      #- id: pulumi-config
      #  name: üõ†Ô∏è Pulumi Config üõ†Ô∏è
      #  env:
      #    ACTIONS_STEP_DEBUG: true
      #    KUBECONFIG: .kube/config
      #    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #    PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
      #    PULUMI_CONFIG_PASSPHRASE: foobarbaz
      #    PULUMI_BACKEND_URL: file://./.pulumi
      #  run: |
      #    pulumi login
      #    pulumi install
      #    pulumi stack select --create /kargo/ci
      #    pulumi config set kubernetes kind
      #    pulumi config set kubecontext kind-kargo

      - id: pulumi-up
        name: üöÄ Pulumi Up üöÄ
        uses: pulumi/actions@v5
        env:
          ACTIONS_STEP_DEBUG: true
          KUBECONFIG: .kube/config
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          PULUMI_CONFIG_PASSPHRASE: foobarbaz
          PULUMI_BACKEND_URL: file://./.pulumi
        with:
          command: up
          refresh: true
          upsert: true
          stack-name: /kargo/ci
          secrets-provider: passphrase
          cloud-url: file://./.pulumi
          work-dir: ./

      - name: üïö Wait for pods üïõ
        uses: CodingNagger/minikube-wait-action@v1.1.1
        env:
          ACTIONS_STEP_DEBUG: true
          KUBECONFIG: .kube/config
        with:
          max-retry-attempts: 12
          retry-delay: 10

      - id: pulumi-destroy
        name: üí£ Pulumi Destroy üí£
        uses: pulumi/actions@v5
        if: always()
        env:
          ACTIONS_STEP_DEBUG: true
          KUBECONFIG: .kube/config
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          PULUMI_CONFIG_PASSPHRASE: foobarbaz
          PULUMI_BACKEND_URL: file://./.pulumi
        with:
          command: destroy
          refresh: true
          stack-name: organization/kargo/ci
          secrets-provider: passphrase
          cloud-url: file://./.pulumi
          work-dir: ./
